import pytest

from contextlib import contextmanager
from wand.image import Image

from planitor import attachments

# PDF with three pages, each page a different color tile for easier debugging
PDF_CONTENTS = b"%PDF-1.3\n%\xc4\xe5\xf2\xe5\xeb\xa7\xf3\xa0\xd0\xc4\xc6\n4 0 obj\n<< /Length 5 0 R /Filter /FlateDecode >>\nstream\nx\x01+T\x08T(T0\x00B\x13\x03\x08.JU\x08W\xc8S\xd0w.6TH.V0\xd037\xb3032\xc7\xc2(NF\xd6\xc8\x05\xd4\x98\xa6\x10\x08\x00\xdf\xc3\x11\xc0\nendstream\nendobj\n5 0 obj\n55\nendobj\n2 0 obj\n<< /Type /Page /Parent 3 0 R /Resources 6 0 R /Contents 4 0 R /MediaBox [0 0 400 400]\n/Rotate 0 >>\nendobj\n6 0 obj\n<< /ProcSet [ /PDF ] /ColorSpace << /Cs1 7 0 R >> >>\nendobj\n8 0 obj\n<< /Length 9 0 R /N 3 /Alternate /DeviceRGB /Filter /FlateDecode >>\nstream\nx\x01\x9d\x96wTS\xd9\x16\x87\xcf\xbd7\xbd\xd0\x12\" %\xf4\x1az\t \xd2;H\x15\x04Q\x89I\x80P\x02\x86\x84&vD\x05F\x14\x11)VdT\xc0\x01G\x87\"cE\x14\x0b\x83\x82b\xd7\t\xf2\x10P\xc6\xc1QDE\xe5\xdd\x8ck\t\xef\xad5\xf3\xde\x9a\xfd\xc7Y\xdf\xd9\xe7\xb7\xd7\xd9g\xef}\xd7\xba\x00P\xfc\x82\x04\xc2tX\x01\x804\xa1X\x14\xee\xeb\xc1\\\x12\x13\xcb\xc4\xf7\x02\x18\x10\x01\x0eX\x01\xc0\xe1ff\x04G\xf8D\x02\xd4\xfc\xbd=\x99\x99\xa8H\xc6\xb3\xf6\xee.\x80d\xbb\xdb,\xbfP&s\xd6\xff\x7f\x91\"7C$\x06\x00\nE\xd56<~&\x17\xe5\x02\x94S\xb3\xc5\x192\xff\x04\xca\xf4\x95)2\x8612\x16\xa1\t\xa2\xac\"\xe3\xc4\xafl\xf6\xa7\xe6+\xbb\xc9\x98\x97&\xe4\xa1\x1aY\xce\x19\xbc4\x9e\x8c\xbbP\xde\x9a%\xe1\xa3\x8c\x04\xa1\\\x98%\xe0g\xa3|\x07e\xbdTI\x9a\x00\xe5\xf7(\xd3\xd3\xf8\x9cL\x000\x14\x99_\xcc\xe7&\xa1l\x892E\x14\x19\xee\x89\xf2\x02\x00\x08\x94\xc49\xbcr\x0e\x8b\xf99h\x9e\x00x\xa6g\xe4\x8a\x04\x89Ib\xa6\x11\xd7\x98i\xe5\xe8\xc8f\xfa\xf1\xb3S\xf9b1+\x94\xc3M\xe1\x88xL\xcf\xf4\xb4\x0c\x8e0\x17\x80\xafo\x96E\x01%Ym\x99h\x91\xed\xad\x1c\xed\xedY\xd6\xe6h\xf9\xbf\xd9\xdf\x1e~S\xfd=\xc8z\xfbU\xf1&\xec\xcf\x9eA\x8c\x9eY\xdfl\xec\xac/\xbd\x16\x00\xf6$Z\x9b\x1d\xb3\xbe\x95U\x00\xb4m\x06@\xe5\xe1\xacO\xef \x00\xf2\x05\x00\xb4\xde\x9c\xf3\x1e\x86l^\x92\xc4\xe2\x0c'\x0b\x8b\xec\xecls\x01\x9fk.+\xe87\xfb\x9f\x82o\xca\xbf\x869\xf7\x99\xcb\xee\xfbV;\xa6\x17?\x81#I\x153eE\xe5\xa6\xa7\xa6KD\xcc\xcc\x0c\x0e\x97\xcfd\xfd\xf7\x10\xff\xe3\xc09i\xcd\xc9\xc3,\x9c\x9f\xc0\x17\xf1\x85\xe8UQ\xe8\x94\t\x84\x89h\xbb\x85<\x81X\x90.d\n\x84\x7f\xd5\xe1\x7f\x186'\x07\x19~\x9dk\x14hu_\x00}\x859P\xb8I\x07\xc8o=\x00C#\x03$n?z\x02}\xeb[\x101\n\xc8\xbe\xbch\xad\x91\xafs\x8f2z\xfe\xe7\xfa\x1f\x0b\\\x8an\xe1LA\"S\xe6\xf6\x0c\x8fdr%\xa2,\x19\xa3\xdf\x84l\xc1\x02\x12\x90\x07t\xa0\n4\x81.0\x02,`\r\x1c\x803p\x03\xde \x00\x84\x80H\x10\x03\x96\x03.H\x02i@\x04\xb2A>\xd8\x00\nA1\xd8\x01v\x83jp\x00\xd4\x81z\xd0\x04N\x826p\x06\\\x04W\xc0\rp\x0b\x0c\x80G@\n\x86\xc1K0\x01\xde\x81i\x08\x82\xf0\x10\x15\xa2A\xaa\x90\x16\xa4\x0f\x99B\xd6\x10\x1bZ\x08yCAP8\x14\x03\xc5C\x89\x90\x10\x92@\xf9\xd0&\xa8\x18*\x83\xaa\xa1CP=\xf4#t\x1a\xba\x08]\x83\xfa\xa0\x07\xd0 4\x06\xfd\x01}\x84\x11\x98\x02\xd3a\r\xd8\x00\xb6\x80\xd9\xb0;\x1c\x08G\xc2\xcb\xe0Dx\x15\x9c\x07\x17\xc0\xdb\xe1J\xb8\x16>\x0e\xb7\xc2\x17\xe1\x1b\xf0\x00,\x85_\xc2\x93\x08@\xc8\x08\x03\xd1FX\x08\x1b\xf1DB\x90X$\x01\x11!k\x91\"\xa4\x02\xa9E\x9a\x90\x0e\xa4\x1b\xb9\x8dH\x91q\xe4\x03\x06\x87\xa1a\x98\x18\x16\xc6\x19\xe3\x87Y\x8c\xe1bVa\xd6bJ0\xd5\x98c\x98VL\x17\xe66f\x103\x81\xf9\x82\xa5b\xd5\xb1\xa6X'\xac?v\t6\x11\x9b\x8d-\xc4V`\x8f`[\xb0\x97\xb1\x03\xd8a\xec;\x1c\x0e\xc7\xc0\x19\xe2\x1cp~\xb8\x18\\2n5\xae\x04\xb7\x0f\xd7\x8c\xbb\x80\xeb\xc3\r\xe1&\xf1x\xbc*\xde\x14\xef\x82\x0f\xc1s\xf0b|!\xbe\n\x7f\x1c\x7f\x1e\xdf\x8f\x1f\xc6\xbf'\x90\tZ\x04k\x82\x0f!\x96 $l$T\x10\x1a\x08\xe7\x08\xfd\x84\x11\xc24Q\x81\xa8Ot\"\x86\x10y\xc4\\b)\xb1\x8e\xd8A\xbcI\x1c&N\x93\x14I\x86$\x17R$)\x99\xb4\x81TIj\"]&=&\xbd!\x93\xc9:dGr\x18Y@^O\xae$\x9f _%\x0f\x92?P\x94(&\x14OJ\x1cEB\xd9N9J\xb9@y@yC\xa5R\r\xa8n\xd4X\xaa\x98\xba\x9dZO\xbdD}J}/G\x933\x97\xf3\x97\xe3\xc9\xad\x93\xab\x91k\x95\xeb\x97{%O\x94\xd7\x97w\x97_.\x9f'_!\x7fJ\xfe\xa6\xfc\xb8\x02Q\xc1@\xc1S\x81\xa3\xb0V\xa1F\xe1\xb4\xc2=\x85IE\x9a\xa2\x95b\x88b\x9ab\x89b\x83\xe25\xc5Q%\xbc\x92\x81\x92\xb7\x12O\xa9@\xe9\xb0\xd2%\xa5!\x1aB\xd3\xa5y\xd2\xb8\xb4M\xb4:\xdae\xda0\x1dG7\xa4\xfb\xd3\x93\xe9\xc5\xf4\x1f\xe8\xbd\xf4\te%e[\xe5(\xe5\x1c\xe5\x1a\xe5\xb3\xcaR\x06\xc20`\xf83R\x19\xa5\x8c\x93\x8c\xbb\x8c\x8f\xf34\xe6\xb9\xcf\xe3\xcf\xdb6\xafi^\xff\xbc)\x95\xf9*n*|\x95\"\x95f\x95\x01\x95\x8f\xaaLUo\xd5\x14\xd5\x9d\xaam\xaaO\xd40j&jaj\xd9j\xfb\xd5.\xab\x8d\xcf\xa7\xcfw\x9e\xcf\x9d_4\xff\xe4\xfc\x87\xea\xb0\xba\x89z\xb8\xfaj\xf5\xc3\xea=\xea\x93\x1a\x9a\x1a\xbe\x1a\x19\x1aU\x1a\x974\xc65\x19\x9an\x9a\xc9\x9a\xe5\x9a\xe74\xc7\xb4hZ\x0b\xb5\x04Z\xe5Z\xe7\xb5^0\x95\x99\xee\xccTf%\xb3\x8b9\xa1\xad\xae\xed\xa7-\xd1>\xa4\xdd\xab=\xadc\xa8\xb3Xg\xa3N\xb3\xce\x13]\x92.[7A\xb7\\\xb7SwBOK/X/_\xafQ\xef\xa1>Q\x9f\xad\x9f\xa4\xbfG\xbf[\x7f\xca\xc0\xd0 \xda`\x8bA\x9b\xc1\xa8\xa1\x8a\xa1\xbfa\x9ea\xa3\xe1c#\xaa\x91\xab\xd1*\xa3Z\xa3;\xc68c\xb6q\x8a\xf1>\xe3[&\xb0\x89\x9dI\x92I\x8d\xc9MS\xd8\xd4\xdeT`\xba\xcf\xb4\xcf\x0ck\xe6h&4\xab5\xbb\xc7\xa2\xb0\xdcYY\xacF\xd6\xa09\xc3<\xc8|\xa3y\x9b\xf9+\x0b=\x8bX\x8b\x9d\x16\xdd\x16_,\xed,S-\xeb,\x1fY)Y\x05Xm\xb4\xea\xb0\xfa\xc3\xda\xc4\x9ak]c}\xc7\x86j\xe3c\xb3\xce\xa6\xdd\xe6\xb5\xad\xa9-\xdfv\xbf\xed};\x9a]\xb0\xdd\x16\xbbN\xbb\xcf\xf6\x0e\xf6\"\xfb&\xfb1\x07=\x87x\x87\xbd\x0e\xf7\xd8tv(\xbb\x84}\xd5\x11\xeb\xe8\xe1\xb8\xce\xf1\x8c\xe3\x07'{'\xb1\xd3I\xa7\xdf\x9dY\xce)\xce\r\xce\xa3\x0b\x0c\x17\xf0\x17\xd4-\x18r\xd1q\xe1\xb8\x1cr\x91.d.\x8c_xp\xa1\xd4U\xdb\x95\xe3Z\xeb\xfa\xccM\xd7\x8d\xe7v\xc4m\xc4\xdd\xd8=\xd9\xfd\xb8\xfb+\x0fK\x0f\x91G\x8b\xc7\x94\xa7\x93\xe7\x1a\xcf\x0b^\x88\x97\xafW\x91W\xaf\xb7\x92\xf7b\xefj\xef\xa7>:>\x89>\x8d>\x13\xbev\xbe\xab}/\xf8a\xfd\x02\xfdv\xfa\xdd\xf3\xd7\xf0\xe7\xfa\xd7\xfbO\x048\x04\xac\t\xe8\n\xa4\x04F\x04V\x07>\x0b2\t\x12\x05u\x04\xc3\xc1\x01\xc1\xbb\x82\x1f/\xd2_$\\\xd4\x16\x02B\xfcCv\x85<\t5\x0c]\x15\xfas\x18.,4\xac&\xecy\xb8Ux~xw\x04-bEDC\xc4\xbbH\x8f\xc8\xd2\xc8G\x8b\x8d\x16K\x16wF\xc9G\xc5E\xd5GME{E\x97EK\x97X,Y\xb3\xe4F\x8cZ\x8c \xa6=\x16\x1f\x1b\x15{$vr\xa9\xf7\xd2\xddK\x87\xe3\xec\xe2\n\xe3\xee.3\\\x96\xb3\xec\xdar\xb5\xe5\xa9\xcb\xcf\xae\x90_\xc1Yq*\x1e\x1b\x1f\x1d\xdf\x10\xff\x89\x13\xc2\xa9\xe5L\xae\xf4_\xb9w\xe5\x04\xd7\x93\xbb\x87\xfb\x92\xe7\xc6+\xe7\x8d\xf1]\xf8e\xfc\x91\x04\x97\x84\xb2\x84\xd1D\x97\xc4]\x89cI\xaeI\x15I\xe3\x02OA\xb5\xe0u\xb2_\xf2\x81\xe4\xa9\x94\x90\x94\xa3)3\xa9\xd1\xa9\xcdi\x84\xb4\xf8\xb4\xd3B%a\x8a\xb0+]3='\xbd/\xc34\xa30C\xba\xcai\xd5\xeeU\x13\xa2@\xd1\x91L(sYf\xbb\x98\x8e\xfeL\xf5H\x8c$\x9b%\x83Y\x0b\xb3j\xb2\xdegGe\x9f\xcaQ\xcc\x11\xe6\xf4\xe4\x9a\xe4n\xcb\x1d\xc9\xf3\xc9\xfb~5f5wug\xbev\xfe\x86\xfc\xc15\xeek\x0e\xad\x85\xd6\xae\\\xdb\xb9Nw]\xc1\xba\xe1\xf5\xbe\xeb\x8fm mH\xd9\xf0\xcbF\xcb\x8de\x1b\xdfn\x8a\xde\xd4Q\xa0Q\xb0\xbe`h\xb3\xef\xe6\xc6B\xb9BQ\xe1\xbd-\xce[\x0el\xc5l\x15l\xed\xddf\xb3\xadj\xdb\x97\"^\xd1\xf5b\xcb\xe2\x8a\xe2O%\xdc\x92\xeb\xdfY}W\xf9\xdd\xcc\xf6\x84\xed\xbd\xa5\xf6\xa5\xfbw\xe0v\x08w\xdc\xdd\xe9\xba\xf3X\x99bY^\xd9\xd0\xae\xe0]\xad\xe5\xcc\xf2\xa2\xf2\xb7\xbbW\xec\xbeVa[q`\x0fi\x8fd\x8f\xb42\xa8\xb2\xbdJ\xafjG\xd5\xa7\xea\xa4\xea\x81\x1a\x8f\x9a\xe6\xbd\xea{\xb7\xed\x9d\xda\xc7\xdb\xd7\xbf\xdfm\x7f\xd3\x01\x8d\x03\xc5\x07>\x1e\x14\x1c\xbc\x7f\xc8\xf7Pk\xadAm\xc5a\xdc\xe1\xac\xc3\xcf\xeb\xa2\xea\xba\xbfg\x7f_\x7fD\xedH\xf1\x91\xcfG\x85G\xa5\xc7\xc2\x8fu\xd5;\xd4\xd77\xa87\x946\xc2\x8d\x92\xc6\xb1\xe3q\xc7o\xfd\xe0\xf5C{\x13\xab\xe9P3\xa3\xb9\xf8\x048!9\xf1\xe2\xc7\xf8\x1f\xef\x9e\x0c<\xd9y\x8a}\xaa\xe9'\xfd\x9f\xf6\xb6\xd0Z\x8aZ\xa1\xd6\xdc\xd6\x89\xb6\xa46i{L{\xdf\xe9\x80\xd3\x9d\x1d\xce\x1d-?\x9b\xff|\xf4\x8c\xf6\x99\x9a\xb3\xcagK\xcf\x91\xce\x15\x9c\x9b9\x9fw~\xf2B\xc6\x85\xf1\x8b\x89\x17\x87:Wt>\xba\xb4\xe4\xd2\x9d\xae\xb0\xae\xde\xcb\x81\x97\xaf^\xf1\xb9r\xa9\xdb\xbd\xfb\xfcU\x97\xabg\xae9];}\x9d}\xbd\xed\x86\xfd\x8d\xd6\x1e\xbb\x9e\x96_\xec~i\xe9\xb5\xefm\xbd\xe9p\xb3\xfd\x96\xe3\xad\x8e\xbe\x05}\xe7\xfa]\xfb/\xde\xf6\xba}\xe5\x8e\xff\x9d\x1b\x03\x8b\x06\xfa\xee.\xbe{\xff^\xdc=\xe9}\xde\xfd\xd1\x07\xa9\x0f^?\xccz8\xfdh\xfdc\xec\xe3\xa2'\nO*\x9e\xaa?\xad\xfd\xd5\xf8\xd7f\xa9\xbd\xf4\xec\xa0\xd7`\xcf\xb3\x88g\x8f\x86\xb8C/\xff\x95\xf9\xafO\xc3\x05\xcf\xa9\xcf+F\xb4F\xeaG\xadG\xcf\x8c\xf9\x8c\xddz\xb1\xf4\xc5\xf0\xcb\x8c\x97\xd3\xe3\x85\xbf)\xfe\xb6\xf7\x95\xd1\xab\x9f~w\xfb\xbdgb\xc9\xc4\xf0k\xd1\xeb\x99?J\xde\xa8\xbe9\xfa\xd6\xf6m\xe7d\xe8\xe4\xd3wi\xef\xa6\xa7\x8a\xde\xab\xbe?\xf6\x81\xfd\xa1\xfbc\xf4\xc7\x91\xe9\xecO\xf8O\x95\x9f\x8d?w|\t\xfc\xf2x&mf\xe6\xdf\xf7\x84\xf3\xfb\nendstream\nendobj\n9 0 obj\n2612\nendobj\n7 0 obj\n[ /ICCBased 8 0 R ]\nendobj\n11 0 obj\n<< /Length 12 0 R /Filter /FlateDecode >>\nstream\nx\x01+T\x08T(T0\x00B\x13\x03\x08.JU\x08W\xc8S\xd0w.6TH.\x06I\xe9Y\x9a(\x18*\x14'\xa3+KS\x08\x04\x00\xc3\xc6\x0e\x1c\nendstream\nendobj\n12 0 obj\n49\nendobj\n10 0 obj\n<< /Type /Page /Parent 3 0 R /Resources 13 0 R /Contents 11 0 R /MediaBox\n[0 0 400 400] /Rotate 0 >>\nendobj\n13 0 obj\n<< /ProcSet [ /PDF ] /ColorSpace << /Cs1 7 0 R >> >>\nendobj\n15 0 obj\n<< /Length 16 0 R /Filter /FlateDecode >>\nstream\nx\x01+T\x08T(T0\x00B\x13\x03\x08.JU\x08W\xc8S\xd0w.6TH.V0\x04K\x16'\xa3\xabIS\x08\x04\x00\x9bF\r\x81\nendstream\nendobj\n16 0 obj\n45\nendobj\n14 0 obj\n<< /Type /Page /Parent 3 0 R /Resources 17 0 R /Contents 15 0 R /MediaBox\n[0 0 400 400] /Rotate 0 >>\nendobj\n17 0 obj\n<< /ProcSet [ /PDF ] /ColorSpace << /Cs1 7 0 R >> >>\nendobj\n3 0 obj\n<< /Type /Pages /MediaBox [0 0 612 792] /Count 3 /Kids [ 2 0 R 10 0 R 14 0 R\n] >>\nendobj\n18 0 obj\n<< /Type /Catalog /Pages 3 0 R >>\nendobj\n1 0 obj\n<< /Producer (macOS Version 10.15.5 \\(Build 19F101\\) Quartz PDFContext) /CreationDate\n(D:20200708145226Z00'00') /ModDate (D:20200708145226Z00'00') >>\nendobj\nxref\n0 19\n0000000000 65535 f \n0000003922 00000 n \n0000000169 00000 n \n0000003775 00000 n \n0000000022 00000 n \n0000000151 00000 n \n0000000283 00000 n \n0000003084 00000 n \n0000000351 00000 n \n0000003064 00000 n \n0000003263 00000 n \n0000003119 00000 n \n0000003244 00000 n \n0000003380 00000 n \n0000003589 00000 n \n0000003449 00000 n \n0000003570 00000 n \n0000003706 00000 n \n0000003872 00000 n \ntrailer\n<< /Size 19 /Root 18 0 R /Info 1 0 R /ID [ <77538142f2cc686fd3dd4c110f23c673>\n<77538142f2cc686fd3dd4c110f23c673> ] >>\nstartxref\n4087\n%%EOF\n"  # noqa


@pytest.fixture
def mock_get_pdf_image(monkeypatch):
    @contextmanager
    def get_pdf_image(url: str):
        yield Image(blob=PDF_CONTENTS)

    monkeypatch.setattr(attachments, "get_pdf_image", get_pdf_image)


def test_get_thumbnails(mock_get_pdf_image):
    thumbnails = list(attachments.get_thumbnails("foo"))
    assert len(thumbnails) == 3


def test_update_attachment_with_pdf_thumbnail(
    db, attachment, monkeypatch, mock_get_pdf_image
):
    def mock_upload(bytes_io, key):
        pass

    monkeypatch.setattr(attachments, "upload", mock_upload)
    attachments._update_attachment_with_pdf_thumbnails(attachment, db)
