{% extends "base.html" %}

{% from "includes/breadcrumbs.html" import breadcrumbs, breadcrumb %}

{% set council_slug = council.council_type.value.slug %}

{% macro entities(case) %}
  {% for applicant, case_entities in case.entities | groupby('applicant') %}
    <div class="mb-2 minilabel">
      {{ "Málsaðilar" if applicant else "Aðilar sem vísað er í" }}
    </div>
    <div class="entities mb-2">
    {% for case_entity in case_entities %}
      {% set e = case_entity.entity %}
      <div class="mb-1">
        <a href="{{ url_for('get_company', kennitala=e.kennitala, slug=e.slug)
                    if e.entity_type.name == 'company' else
                    url_for('get_person', kennitala=e.kennitala, slug=e.slug) }}"
          class="text-blue-700 font-semibold font-sm truncate"
        >
          <span class="sf-symbol">
            {% if e.entity_type.name == "company" %}
              {% include "symbols/briefcase.fill.svg" %}
            {% else %}
              {% include "symbols/person.fill.svg" %}
            {% endif %}
          </span>
          <span>{{ e.name }}</span>
        </a>
      </div>
    {% endfor %}
    </div>
  {% endfor %}
{% endmacro %}

{% macro table(minutes) %}
  <table class="table-auto min-w-full max-w-full">
    <thead>
      <tr>
        <th class="px-0 md:px-3 py-2 minilabel text-left">Bókun</th>
        <th class="px-0 md:px-3 py-2 minilabel text-left">Fundur</th>
        <th class="px-0 md:px-3 py-2 minilabel text-right">Staða</th>
      </tr>
    </thead>
    <tbody>
      {% for minute in minutes %}
      <tr class="{{ 'md:bg-white' if loop.index % 2 == 0 }} leading-relaxed">
        <td class="md:border px-0 md:px-3 lg:px-3 py-2">
          <a href="{{ url_for('get_minute',
            muni_slug=minute.case.council.municipality.slug,
            council_slug=minute.case.council.council_type.value.slug,
            case_id=minute.case.serial,
            minute_id=h.encode(minute.id)) }}" class="underline">
            {{ human_date(minute.meeting.start) -}}</a>
          <span class="hidden md:inline">
            -
            {{ timeago(minute.meeting.start) }}</span>
        </td>
        <td class="md:border px-0 md:px-3 py-2">
          <a href="{{ url_for('get_meeting',
            muni_slug=municipality.slug,
            council_slug=council.council_type.value.slug,
            meeting_id=h.encode(minute.meeting.id)) }}" class="font-bold text-midnight hover:underline whitespace-no-wrap">
            Nr.
            {{ minute.meeting.name }}
          </a>
        </td>
        <td class="md:border px-0 md:px-3 py-2 text-right">
          <div style="max-width: 128px;" class="pill pill-big truncate pill-{{ minute.status.value.color if minute.status else 'none' }} font-bold">
            {{ minute.status.value.label if minute.status else "Annað" }}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% macro get_cases(cases, count) %}
  <ul>
    {% for case in cases[:3] %}
    <li class="mb-2 list-disc ml-4">
      <div class="text-sm">
        <span>
          <a href="{{ url_for('get_case',
            muni_slug=case.council.municipality.slug,
            council_slug=case.council.council_type.value.slug,
            case_id=case.serial) }}">
            <span class="underline">{{ case.headline }}</span>
            <span class="text-gray-600 font-thin">{{- case.serial -}}</span>
          </a>
        </span>
      </div>
      <div class="font-light text-xs">
        <span class="highlight-{{ case.status.value.color if case.status else 'none' }}">
          {{ case.status.value.label if case.status else "Annað" }}
        </span> {{ human_date(case.updated) }}
      </div>
    </li>
    {% endfor %}
  </ul>
  {% if count > 3 %}
    <div class="text-sm font-bold">
      <a href="#" class="text-midnight">
      {% if count == 4 %}
        … og eitt annað mál
      {% else %}
        … og {{ count - 3 }} önnur mál
      {% endif %}
      </a>
    </div>
  {% endif %}
{% endmacro %}

{% block title %}Málsferill {{ case.serial }} / {{ case.council.name }} í {{ municipality.name }} — {{ super() }}{% endblock %}
{% block og_title %}Málsferill {{ case.serial }} / {{ case.council.name }} í {{ municipality.name }} — {{ super() }}{% endblock %}

{% block body %}
  <div class="my-8 mt-4 sm:mt-8">

    {% block breadcrumbs %}
      {% call breadcrumbs() %}
      {{ breadcrumb(url_for('get_municipality', muni_slug=municipality.slug), municipality.name, dash=False) }}
      {{ breadcrumb(url_for('get_council', muni_slug=municipality.slug, council_slug=council_slug), council.name) }}
      {{ breadcrumb(None, case.serial) }}
      {% endcall %}
    {% endblock %}

    <div class="grid grid-cols-1 col-gap-8 w-full {{ 'lg:grid-cols-5' if case.get_coordinates() }}">

      <div class="mb-6 lg:col-span-3">

        <div class="mb-6">
          <div class="flex justify-between items-start">
            <div>
              <div class="flex-shrink text-2xl tracking-tight">{{ case.headline }}</div>
              {% if case.address %}
              <div class="text-sm font-bold">
                {{ case.address }}
                {% if case.stadgreinir %}
                <span class="text-gray-600 font-thin ml-2">{{ case.stadgreinir }}</span>
                {% endif %}
              </div>
              {% endif %}
            </div>
            <div class="follow-case" data-state="{{ "following" if subscription else "" }}" data-id="{{ case.id }}">
              Vakta {{ case.serial }}
            </div>
          </div>
        </div>

        <div class="mb-6">
          Síðast
          <div class="pill pill-big pill-{{ case.status.value.color if case.status else 'none' }} font-bold align-middle shadow-lg">
            {{- case.status.value.label if case.status else "tekið fyrir" -}}
          </div>
          á fundi
          {{ timeago(last_updated).lower() }}.
        </div>

        <div class="mb-6">
          {{ entities(case) }}
        </div>

        {% block inner %}
        <div class="">
          {{ table(minutes) }}
        </div>
        {% endblock%}

      </div>

      <div class="mb-6 lg:col-span-2">
        <div class="shadow-lg rounded-md overflow-hidden bg-white">

          {% if case.get_coordinates() %}
            {% set lat, lon = case.get_coordinates() %}
            <div
              class="map w-full lazyload"
              data-address="{{ case.address }}" data-lat="{{ lat }}" data-lon="{{ lon }}"
              id="map-{{ case.id }}"
              style="height: 18rem;"
            >
            </div>
          {% endif %}

          {% set case_count = (related_cases.count() if related_cases else 0) %}

          {% if case_count %}
            <div class="p-3">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-xl font-bold">
                    <a href="{{ url_for("get_address", hnitnum=case.iceaddr.hnitnum) }}" class="underline">{{ case.iceaddr }}</a>
                  </div>
                  <div class="text-sm font-thin tracking-tight mb-4">
                    {{ case.iceaddr.postnr }} {{ case.iceaddr.stadur_nf }}
                  </div>
                </div>
                <div class="follow-address" data-state="{{ "following" if address_subscription else "" }}" data-hnitnum="{{ case.iceaddr.hnitnum }}">
                </div>
              </div>
              {{ get_cases(related_cases, case_count) }}
              <div class="text-xs font-thin tracking-tight mt-4">
                Landnúmer: {{ case.iceaddr.landnr }}
                {% if case.iceaddr %}
                <span class="ml-2 text-powder-dark hover:text-powder-darker font-bold">
                  <a href="https://skra.is/leit-i-fasteignaskra?streetname={{ case.iceaddr.landnr }}&pos=fp-advanced-search">
                    → skrá.is
                  </a>
                </span>
                {% endif %}
                <br>
                Hnitnúmer: {{ case.iceaddr.hnitnum }}
              </div>
            </div>
          {% endif %}

          <div class="hidden">{{ case.get_coordinates() }}</div>
        </div>
      </div>

    </div>

  </div>

{% endblock body %}