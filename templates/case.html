{% extends "base.html" %}

{% from "includes/breadcrumbs.html" import breadcrumbs, breadcrumb %}

{% set council_slug = council.council_type.value.slug %}

{% macro entities(case) %}
  {% for applicant, case_entities in case.entities | groupby('applicant') %}
    <div class="mb-2 minilabel">
      {{ "Málsaðilar" if applicant else "Aðilar sem vísað er í" }}
    </div>
    <div class="entities mb-2">
    {% for case_entity in case_entities %}
      {% set e = case_entity.entity %}
      <div class="mb-1">
        <a href="{{ url_for('get_company', kennitala=e.kennitala, slug=e.slug)
                    if e.entity_type.name == 'company' else
                    url_for('get_person', kennitala=e.kennitala, slug=e.slug) }}"
          class="text-blue-700 font-semibold font-sm truncate"
        >
          <span class="sf-symbol">
            {% if e.entity_type.name == "company" %}
              {% include "symbols/briefcase.fill.svg" %}
            {% else %}
              {% include "symbols/person.fill.svg" %}
            {% endif %}
          </span>
          <span>{{ e.name }}</span>
        </a>
      </div>
    {% endfor %}
    </div>
  {% endfor %}
{% endmacro %}

{% macro table(minutes) %}
  <table class="table-auto min-w-full max-w-full">
    <thead>
      <tr>
        <th class="px-0 md:px-4 py-2 minilabel text-left">Bókun</th>
        <th class="px-0 md:px-4 py-2 minilabel text-left">Fundur</th>
        <th class="px-0 md:px-4 py-2 minilabel text-right">Staða</th>
      </tr>
    </thead>
    <tbody>
      {% for minute in minutes %}
      <tr class="{{ 'md:bg-white' if loop.index % 2 == 0 }} leading-relaxed">
        <td class="md:border px-0 md:px-4 lg:px-4 py-2">
          <a href="{{ url_for('get_minute',
            muni_slug=minute.case.council.municipality.slug,
            council_slug=minute.case.council.council_type.value.slug,
            case_id=minute.case.serial,
            minute_id=h.encode(minute.id)) }}" class="underline">
            {{ human_date(minute.meeting.start) -}}</a>
          <span class="hidden md:inline">
            -
            {{ timeago(minute.meeting.start) }}</span>
        </td>
        <td class="md:border px-0 md:px-4 py-2">
          <a href="{{ url_for('get_meeting',
            muni_slug=municipality.slug,
            council_slug=council.council_type.value.slug,
            meeting_id=h.encode(minute.meeting.id)) }}" class="font-bold text-midnight hover:underline whitespace-no-wrap">
            Nr.
            {{ minute.meeting.name }}
          </a>
        </td>
        <td class="md:border px-0 md:px-4 py-2 text-right">
          <div style="max-width: 128px;" class="pill pill-big truncate pill-{{ minute.status.value.color if minute.status else 'none' }} font-bold">
            {{ minute.status.value.label if minute.status else "Annað" }}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% macro cases_table(cases) %}
  <table class="table-auto min-w-full max-w-full">
    <thead>
      <tr>
        <th class="px-0 md:px-4 py-2 minilabel text-left">Mál</th>
        <th class="px-0 md:px-4 py-2 minilabel text-left"></th>
        <th class="px-0 md:px-4 py-2 minilabel text-right">Staða</th>
      </tr>
    </thead>
    <tbody>
      {% for case in cases %}
      <tr class="{{ 'md:bg-white' if loop.index % 2 == 0 }} leading-relaxed">
        <td class="md:border px-0 md:px-4 py-2">
          <div class="font-bold">{{ human_date(case.updated) }}</div>
          <div class="text-gray-600 text-sm">{{ case.council.name }}</div>
        </td>
        <td class="md:border px-0 md:px-4 lg:px-4 py-2">
          <a href="{{ url_for('get_case',
            muni_slug=case.council.municipality.slug,
            council_slug=case.council.council_type.value.slug,
            case_id=case.serial) }}" class="underline block">
            {{- case.serial -}}
          </a>
          <div class="text-gray-600 text-sm">{{ case.headline }}</div>
        </td>
        <td class="md:border px-0 md:px-4 py-2 text-right">
          <div style="max-width: 128px;" class="pill pill-big truncate pill-{{ case.status.value.color if case.status else 'none' }} font-bold">
            {{ case.status.value.label if case.status else "Annað" }}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% block title %}Málsferill {{ case.serial }} / {{ case.council.name }} í {{ municipality.name }} — {{ super() }}{% endblock %}
{% block og_title %}Málsferill {{ case.serial }} / {{ case.council.name }} í {{ municipality.name }} — {{ super() }}{% endblock %}

{% block body %}
  <div class="my-8 mt-4 sm:mt-8">

    {% block breadcrumbs %}
      {% call breadcrumbs() %}
      {{ breadcrumb(url_for('get_municipality', muni_slug=municipality.slug), municipality.name, dash=False) }}
      {{ breadcrumb(url_for('get_council', muni_slug=municipality.slug, council_slug=council_slug), council.name) }}
      {{ breadcrumb(None, case.serial) }}
      {% endcall %}
    {% endblock %}

    <div class="grid grid-cols-1 col-gap-8 w-full {{ 'lg:grid-cols-5' if case.get_coordinates() }}">

      <div class="mb-6 lg:col-span-3">

        <div class="mb-6">
          <div class="flex justify-between items-center">
            <div class="flex-shrink">
              <div class="flex-shrink text-2xl tracking-tight">{{ case.headline }}</div>
            </div>
          </div>
          {% if case.address %}
          <div class="text-sm font-bold">
            {{ case.address }}
            {% if case.iceaddr %}
            <span class="ml-2 text-powder-dark hover:text-powder-darker font-bold">
              <a href="https://skra.is/leit-i-fasteignaskra?streetname={{ case.iceaddr.landnr }}&pos=fp-advanced-search">
                → skra.is
              </a>
            </span>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <div class="mb-6">
          Síðast
          <div class="pill pill-big pill-{{ case.status.value.color if case.status else 'none' }} font-bold align-middle shadow-lg">
            {{- case.status.value.label if case.status else "tekið fyrir" -}}
          </div>
          á fundi
          {{ timeago(last_updated).lower() }}.
        </div>

        <div class="mb-6">
          {{ entities(case) }}
        </div>

        {% block inner %}
        <div class="">
          {{ table(minutes) }}
        </div>
        {% if related_cases and related_cases.count() %}
        <div class="mt-6">
          <hr>
          <div class="text-xl font-thin tracking-tight mb-4 mt-8">Aðrar bókanir á sama heimilisfangi</div>
          {{ cases_table(related_cases) }}
        </div>
        {% endif %}
        {% endblock%}

      </div>

      <div class="mb-6 lg:col-span-2">
        {% if case.get_coordinates() %}
          {% set lat,
          lon = case.get_coordinates() %}
          <div
              class="map h-64 w-full h-full shadow-lg lazyload mb-6 rounded-md overflow-hidden lg:h-full lg:max-h-screen"
              data-address="{{ case.address }}"
              data-lat="{{ lat }}"
              data-lon="{{ lon }}"
              id="map-{{ case.id }}"
              style="min-height: 24rem;"
          >
          </div>
        {% endif %}
        <div class="hidden">{{ case.get_coordinates() }}</div>
      </div>

    </div>

  </div>

{% endblock body %}