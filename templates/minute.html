{% from "includes/breadcrumbs.html" import breadcrumbs,
breadcrumb %}

{% macro section(class = "") %}
  <div class="px-4 sm:px-6 md:px-0 mb-4 sm:mb-6 {{ class }}">{{ caller() }}</div>
{% endmacro %}

{% extends "base.html" %}
{% block body %}

  {% set council_slug = council.council_type.value.slug %}

  {% call section(class = "mt-4 sm:mt-8 md:px-6") %}
  {% call breadcrumbs() %}
  {{ breadcrumb(url_for('get_municipality', muni_slug=municipality.slug), municipality.name, dash=False) }}
  {{ breadcrumb(url_for('get_council', muni_slug=municipality.slug, council_slug=council_slug), council.name) }}
  {{ breadcrumb(url_for('get_case', muni_slug=municipality.slug, council_slug=council_slug, case_id=case.serial), case.serial) }}
  {{ breadcrumb(None, minute.serial, mobile_collapse=True) }}
  {% endcall %}
  {% endcall %}

  <div class="grid grid-cols-1 gap-4 md:grid-cols-3 items-end md:px-6">

    {% call section(class = "mb-2 sm:mb-4 md:col-span-2 align-bottom") %}
    <div class="text-2xl font-bold">{{ case.address }}</div>
    <div class="text-sm font-bold">
      Verknúmer
      <a href="url_for('get_case', muni_slug=municipality.slug, council_slug=council_slug, case_id=case.serial)" class="text-midnight underline">{{ case.serial }}
        ({{ case_count }})</a>
    </div>
    {% endcall %}

    {% set meeting_url = url_for('get_meeting', muni_slug = municipality.slug, council_slug = council.council_type.value.slug, meeting_id = h.encode(meeting.id)) %}
    {% call section(class = "mb-4 sm:mb-8 md:order-last md:col-span-1") %}
    <div class="rounded-md bg-midnight text-white p-4 shadow-lg">
      <div class="text-lg font-extrabold">
        Fundur
        <a href="{{ meeting_url }}" class="underline font-semibold">
          nr.
          {{ meeting.name }}
        </a>
      </div>
      <div class="text-sm">
        {{ human_date(meeting.start) }}
      </div>
    </div>
    {% endcall %}

  </div>

  <div class="grid grid-cols-1 gap-4 md:grid-cols-3 md:px-6">

    {% call section(class = "mb-2 sm:mb-4 md:col-span-2") %}
    <div class="p-4 bg-white rounded-md shadow-lg">
      <div class="flex">
        <div class="case flex-1">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-shrink text-2xl tracking-tight">{{ minute.headline }}</div>
            <div class="pill pill-big pill-{{ minute.status.value.color if minute.status else 'none' }} font-bold">
              {{ minute.status.value.label if minute.status else "Annað" }}
            </div>
          </div>
          <div class="mb-4">
            <h5 class="uppercase tracking-wide text-gray-700 font-thin text-xs">Fyrirspurn</h5>
            <div>
              {% for kennitala, token in minute.get_inquiry_mention_tokens() -%}
                {% if not kennitala -%}
                  {{ token.replace('\n\n', '<br />')|safe }}
                {% else -%}
                  {% if kennitala.is_person() -%}
                    <a class="text-blue-900 underline" href="{{ url_for('get_person', kennitala=kennitala.kennitala) }}">{{ token }}</a>
                  {% else -%}
                    <a class="text-blue-900 underline" href="{{ url_for('get_company', kennitala=kennitala.kennitala) }}">{{ token }}</a>
                  {% endif -%}
                {% endif -%}
              {% endfor -%}
            </div>
          </div>
          <div>
            <h5 class="uppercase tracking-wide text-gray-700 font-thin text-xs">Svar</h5>
            <p>{{ minute.remarks.replace('\n\n', '<br />')|safe }}</p>
          </div>
        </div>
      </div>
    </div>
    {% endcall %}

    {% call section(class = "mb-2 sm:mb-4") %}

    {% if case.get_coordinates() %}
      <div class="mb-4 sm:mb-6 rounded-md shadow-lg overflow-hidden">
        {% set lat,
        lon = case.get_coordinates() %}
        <div class="map h-48 sm:h-56 md:h-64 w-full lazyload" id="map-{{ case.id }}" data-lat="{{ lat }}" data-lon="{{ lon }}" data-address="{{ case.address }}"></div>
      </div>
    {% endif %}

    <div class="my-8">
      {% for applicant, case_entities in case.entities | groupby('applicant') %}
        <div class="mb-2 uppercase tracking-wide text-gray-700 font-thin text-xs">
          {{ "Málsaðilar" if applicant else "Aðilar sem vísað er í" }}
        </div>
        <div class="entities mb-2">
          {% for case_entity in case_entities %}
            {% set e = case_entity.entity %}
            <div class="mb-1">
              <!-- prettier-ignore -->
              <a href="{{ url_for('get_company', kennitala=e.kennitala, slug=e.slug)
                if e.entity_type.name == 'company' else
                url_for('get_person', kennitala=e.kennitala, slug=e.slug) }}" class="text-blue-700 font-semibold font-sm block truncate">
                <span class="sf-symbol">
                  {% if e.entity_type.name == "company" %}
                    {% include "symbols/briefcase.fill.svg" %}
                  {% else %}
                    {% include "symbols/person.fill.svg" %}
                  {% endif %}
                </span>
                <span>{{ e.name }}</span>
              </a>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    {% endcall %}

  {% endblock body %}